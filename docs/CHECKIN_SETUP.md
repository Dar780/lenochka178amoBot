# Настройка автоматического перевода в "Проживание"

## Описание
Автоматический перевод сделок с этапа "отправка кода от двери" в "Проживание" при совпадении даты заезда с сегодняшней датой.

## Настройка в AmoCRM

### 1. Создание тригера

1. **Войдите в AmoCRM** → Настройки → Автоматизация → Тригеры
2. **Создайте новый тригер**:
   - **Название**: "Перевод в Проживание при заезде"
   - **Воронка**: "Воронка RealtyCalendar" (ID: 9266190)
   - **Этап**: "отправка кода от двери" (ID: 74364970)

### 2. Условие времени

1. **Добавьте условие времени**:
   - **Время**: 15:01 (или любое другое время)
   - **Частота**: Каждый день

### 3. Действие - Вебхук

1. **Добавьте действие "Свой обработчик (код)"**
2. **В поле handler укажите**:
   ```
   https://xn--90a0am.online/amo/checkInHandler.php
   ```
3. **В поле params укажите**:
   ```json
   {
     "leads": [
       {
         "id": "{{lead.id}}",
         "status_id": "74364970",
         "pipeline_id": "9266190"
       }
     ]
   }
   ```

### 4. Финальная конфигурация

```json
{
  "handler": "https://xn--90a0am.online/amo/checkInHandler.php",
  "params": {
    "leads": [
      {
        "id": "{{lead.id}}",
        "status_id": "74364970", 
        "pipeline_id": "9266190"
      }
    ]
  }
}
```

## Логика работы

1. **Тригер срабатывает** каждый день в 15:01
2. **Передает конкретные сделки** через `params.leads`
3. **Проверяет поле "Дата заезда"** (field_id: 833655) для каждой сделки
4. **Если дата заезда = сегодня** → переводит в "Проживание"
5. **Если дата заезда ≠ сегодня** → оставляет как есть

## ID этапов

- **"отправка кода от двери"**: 74364970
- **"Проживание"**: 74364974
- **Поле "Дата заезда"**: 833655

## Логи

- **Файл лога**: `amo/checkin_handler.log`
- **Содержит**: все запросы, проверки дат, результаты перемещений

## Тестирование

### Ручной тест через curl:

```bash
curl -X POST https://xn--90a0am.online/amo/checkInHandler.php \
  -H "Content-Type: application/json" \
  -d '{
    "params": {
      "leads": [
        {
          "id": "12345678",
          "status_id": "74364970",
          "pipeline_id": "9266190"
        }
      ]
    },
    "account": {
      "id": "32247010",
      "subdomain": "lenasutochno178"
    }
  }'
```

### Проверка логов:

```bash
tail -f amo/checkin_handler.log
```

## Возможные проблемы

1. **"ID этапа не установлен"** → Проверьте константы в `checkInHandler.php`
2. **"Поле Дата заезда не найдено"** → Проверьте field_id: 833655
3. **"Нет сделок для перемещения"** → Проверьте даты заезда в сделках
4. **"Получены сделки из webhook"** → Проверьте, что `params.leads` передается корректно

## Преимущества использования params

- ✅ **Точность**: обрабатываются только конкретные сделки
- ✅ **Производительность**: не нужно искать все сделки на этапе
- ✅ **Безопасность**: исключены ошибки с удаленными сделками
- ✅ **Гибкость**: можно передавать любые сделки для проверки 