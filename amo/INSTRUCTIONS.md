# Автоматизация управления датой заезда в AmoCRM

Эта функция автоматически управляет сделками в AmoCRM на основе даты заезда.

## Возможности

1. **Обработчик вебхука** (`processCheckIn.php`)
   - Принимает входящий вебхук от AmoCRM
   - Если дата заезда — завтра → переводит сделку на этап «Отправка инструкции» (ID: 74364966)
   - Если дата заезда не завтра → переводит сделку на этап Отложенная инструкция» (ID: 76985442)

2. **Ежедневная проверка** (`checkInstructions.php`)
   - Скрипт для cron, запускается каждый день в 7:00 утра
   - Ищет все открытые сделки в воронке RealtyCalendar (ID: 9266190)
   - Для сделок с датой заезда завтра переводит их на этап «Отправка инструкции»

## Установка и настройка

### 1. Настройка вебхука в AmoCRM

1. Войдите в AmoCRM → Настройки → Интеграции → Вебхуки.
2. Добавьте URL вебхука:
   ```
   https://xn--90a0am.online/amo/processCheckIn.php
   ```
3. Выберите события:
   - Создание сделки
   - Изменение статуса сделки
   - Изменение полей сделки

### 2. Настройка cron

Чтобы скрипт `checkInstructions.php` запускался автоматически каждый день в 7:00 утра, необходимо добавить его в планировщик задач (cron) на вашем сервере. Для этого выполните следующие шаги:

1. Подключитесь к серверу по SSH.
2. Откройте crontab для редактирования:
   ```bash
   crontab -e
   ```
3. Добавьте строку, которая будет запускать скрипт. **Обратите внимание**, что путь к скрипту должен быть корректным в зависимости от того, где находится ваш проект на сервере. Например:
   ```bash
   0 7 * * * php /путь/к/вашему/проекту/amo/checkInstructions.php
   ```
   Замените `/путь/к/вашему/проекту/` на фактический путь к вашему проекту на сервере.

4. Сохраните изменения и выйдите из редактора.

**Либо используйте файл `crontab.txt`:**

Если вы хотите упростить процесс, вы можете использовать предоставленный файл `crontab.txt`, который содержит нужную строку для cron. Для этого выполните следующие команды:

```bash
crontab -l > current_cron  # Сохраните текущие задания в файл
cat amo/crontab.txt >> current_cron  # Добавьте задания из crontab.txt
crontab current_cron  # Установите новые задания
rm current_cron  # Удалите временный файл
```

### Тестирование

#### Тест вебхука

Вы можете протестировать обработчик вебхука, отправив POST-запрос на указанный URL. Для этого выполните следующую команду в терминале:

```bash
curl -X POST https://xn--90a0am.online/amo/processCheckIn.php -d '{
  "leads": {
    "update": [
      {
        "id": "12345678",  // Замените на актуальный ID вашей сделки
        "status_id": "76985442",  // Или 74364966, в зависимости от нужного статуса
        "pipeline_id": "9266190"
      }
    ]
  },
  "account": {
    "id": "32247010",
    "subdomain": "lenasutochno178"
  }
}'
```

#### Тест ежедневной проверки

Чтобы вручную протестировать скрипт, который запускается по cron, выполните следующую команду:

```bash
php /путь/к/вашему/проекту/amo/checkInstructions.php
```

Замените `/путь/к/вашему/проекту/` на фактический путь к вашему проекту на сервере. Это позволит вам увидеть, как работает скрипт, и проверить, правильно ли он обрабатывает сделки.

## Параметры и ID

- Поле «Дата заезда»: ID 833655
- Воронка RealtyCalendar: ID 9266190
- Этапы сделки:
  - Отложенная инструкция: 76985442
  - Отправка инструкции: 74364966

## Логи

- Лог обработчика вебхука: `amo/checkin_webhook.log`
- Лог ежедневной проверки: `amo/checkin_cron.log` 